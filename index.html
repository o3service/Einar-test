<script>
  const STORAGE_KEY = "kjorerapport_v1";

  const loadReports = () =>
    JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");

  const saveReports = (list) =>
    localStorage.setItem(STORAGE_KEY, JSON.stringify(list));

  function renderReports() {
    const container = document.getElementById("reportList");
    const reports = loadReports();
    container.innerHTML = "";

    if (reports.length === 0) {
      container.innerHTML = '<p class="muted small">Ingen rapporter lagret.</p>';
      return;
    }

    reports.slice().reverse().forEach((r) => {
      const el = document.createElement("div");
      el.className = "report-item";

      el.innerHTML = `
        <div class="report-header">
          <div>${r.date || "Ukjent dato"} – ${r.startLocation || "?"} → ${r.endLocation || "?"}</div>
          <span class="badge">${r.transportType || "?"}</span>
        </div>
        <div class="muted small">
          ${r.client || "Ukjent"} • ${r.totalKm || "-"} km • ${r.startTime || "?"}–${r.endTime || "?"}
        </div>
        ${r.incidents ? `<div class="small">Notat: ${r.incidents}</div>` : ""}
      `;

      container.appendChild(el);
    });
  }

  function calcKm() {
    const s = parseFloat(document.getElementById("odoStart").value);
    const e = parseFloat(document.getElementById("odoEnd").value);
    if (!isNaN(s) && !isNaN(e) && e >= s) {
      document.getElementById("totalKm").value = e - s;
    } else {
      document.getElementById("totalKm").value = "";
    }
  }

  function setupChips() {
    const chips = document.querySelectorAll("#transportTypeChips .chip");
    const hidden = document.getElementById("transportType");

    chips.forEach((chip) => {
      chip.addEventListener("click", () => {
        chips.forEach((c) => c.classList.remove("selected"));
        chip.classList.add("selected");
        hidden.value = chip.dataset.value;
      });
    });
  }

  function exportCsv() {
    const data = loadReports();
    if (data.length === 0) {
      alert("Ingen rapporter å eksportere.");
      return;
    }

    const headers = [
      "Dato","Kunde","Starttid","Sluttid","Startsted","Sluttsted",
      "Følgebil","Transport reg.nr","Type","Km start","Km slutt",
      "Total km","Kjøretid","Ventetid","Vær","Veg","Hendelser",
      "Radio","Dekning","Avvik","Sjåfør"
    ];

    const rows = data.map((r) => [
      r.date || "",
      r.client || "",
      r.startTime || "",
      r.endTime || "",
      r.startLocation || "",
      r.endLocation || "",
      r.escortReg || "",
      r.transportReg || "",
      r.transportType || "",
      r.odoStart || "",
      r.odoEnd || "",
      r.totalKm || "",
      r.driveTime || "",
      r.waitTime || "",
      r.weather || "",
      r.road || "",
      (r.incidents || "").replace(/\n/g, " "),
      r.radioOk || "",
      r.coverage || "",
      (r.deviations || "").replace(/\n/g, " "),
      r.driverName || ""
    ]);

    const csvLines = [];
    csvLines.push(headers.join(";"));
    rows.forEach((row) => {
      const escaped = row.map((field) => {
        const f = String(field).replace(/"/g, '""');
        if (f.includes(";") || f.includes('"') || f.includes("\n")) {
          return `"${f}"`;
        }
        return f;
      });
      csvLines.push(escaped.join(";"));
    });

    const blob = new Blob([csvLines.join("\n")], {
      type: "text/csv;charset=utf-8;"
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    const now = new Date();
    const dateStr = now.toISOString().slice(0, 10);
    a.href = url;
    a.download = `kjorerapporter_${dateStr}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  document.addEventListener("DOMContentLoaded", () => {
    // Sett dagens dato
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("date").value = today;

    setupChips();
    renderReports();

    document.getElementById("odoStart").addEventListener("input", calcKm);
    document.getElementById("odoEnd").addEventListener("input", calcKm);

    document.getElementById("reportForm").addEventListener("submit", (e) => {
      e.preventDefault();

      const r = {
        date: document.getElementById("date").value,
        client: document.getElementById("client").value,
        startTime: document.getElementById("startTime").value,
        endTime: document.getElementById("endTime").value,
        startLocation: document.getElementById("startLocation").value,
        endLocation: document.getElementById("endLocation").value,
        escortReg: document.getElementById("escortReg").value,
        transportReg: document.getElementById("transportReg").value,
        transportType: document.getElementById("transportType").value,
        odoStart: document.getElementById("odoStart").value,
        odoEnd: document.getElementById("odoEnd").value,
        totalKm: document.getElementById("totalKm").value,
        driveTime: document.getElementById("driveTime").value,
        waitTime: document.getElementById("waitTime").value,
        weather: document.getElementById("weather").value,
        road: document.getElementById("road").value,
        incidents: document.getElementById("incidents").value,
        radioOk: document.getElementById("radioOk").value,
        coverage: document.getElementById("coverage").value,
        deviations: document.getElementById("deviations").value,
        driverName: document.getElementById("driverName").value
      };

      const list = loadReports();
      list.push(r);
      saveReports(list);
      renderReports();
      alert("Kjørerapport lagret.");
    });

    document.getElementById("clearForm").addEventListener("click", () => {
      const form = document.getElementById("reportForm");
      form.reset();
      document.getElementById("totalKm").value = "";
      document
        .querySelectorAll("#transportTypeChips .chip")
        .forEach((c) => c.classList.remove("selected"));
      document.getElementById("transportType").value = "";
    });

    document.getElementById("clearAll").addEventListener("click", () => {
      if (confirm("Slette alle rapporter?")) {
        saveReports([]);
        renderReports();
      }
    });

    document.getElementById("exportCsv").addEventListener("click", exportCsv);
  });
</script>
